{% extends "base.html" %}
  {% block content %}
    <div class="MainResultsPage">
      <section class="ResultsGraphs">
        <div class="PersistanceGraph">
          <img src="data:image/svg+xml;base64,{{ diagram }}"></img>
        </div>
        <div class="BarcodeGraph">
          <img src="data:image/svg+xml;base64,{{ barcode }}"></img>
        </div>
      </section>

      <section class="BettiAndEuler">
        <div class="BettiAndEulerTableContainer">
          <table id="BettiAndEulerTable">
            <thead>
              <tr>
                <th colspan="{{ betti|length }}">
                  <span style="float: right; font-weight: normal; text-align: right; width: 6em;">
                    [<input id="CollapseBettiAndEulerTable" type="button" onclick="collapseBettiAndEulerTable(this)" value="Hide">]
                  </span>
                  <h4>Betti numbers and Euler characteristic:</h4>
                </th>
              </tr>
              <tr class="BettiAndEulerHeadRow" id="betti-euler-table-header">
                <th>Length</th>
                <th id="betti-euler-table-last-header">Euler characteristic</th>
              </tr>
            </thead>
            <tbody id="betti-euler-table-body"> 
            </tbody>
          </table>
        </div>
      </section>

      <section class="Statistics">
        <div class="StatisticsTableContainer">
          <table id="StatisticsTable">
            <thead>
              <tr>
                <th colspan="6">
                  <span style="float: right; font-weight: normal; text-align: right; width: 6em;">
                    [<input id="CollapseStatisticsTable" type="button" onclick="collapseStatisticsTable(this)" value="Hide">]
                  </span>
                  <h4>Statistics:</h4>
                </th>
              </tr>
              <tr class="StatisticsHeadRow">
                <th>Dimension</th>
                <th>Number of features</th>
                <th>Minimum length</th>
                <th>Maximum nontrivial length</th>
                <th>Mean length</th>
                <th>Median length</th>
              </tr>
            </thead>
            <tbody id="statistics-body">
            </tbody>
          </table>
        </div>
      </section>

      <section class="RawData" id="raw-data-section">
        <table id="RawDataTable">
          <thead>
            <tr>
              <th colspan="2">
                <span style="float: right; font-weight: normal; text-align: right; width: 6em;">
                  [<input id="CollapseRawDataTable" type="button" onclick="collapseRawDataTable(this)" value="Hide">]
                </span>
                <h4>NumPy arrays of lifetime data:</h4>
              </th>
            </tr>
            <tr class="RawDataHeadRow">
              <th>Raw Data</th>
            </tr>
          </thead>
          <tbody id="raw-data-table-body">
            
          </tbody>
        </table>
      </section>
      {% if latest_result %}
      <span data-latest-result="{{ latest_result }}" id="latest-result" hidden></span>
      {% endif %}
      <script>
        function loadBettiEulerTable(result){
          // load header
          const headerElem = document.getElementById("betti-euler-table-header");
          const lastHeaderColElem = document.getElementById("betti-euler-table-last-header");
          for (var i = 0; i < result.betti.length-2; i++) {
            const colHeaderElem = document.createElement("th");
            const newContent = document.createTextNode("Betti " + i);
            colHeaderElem.appendChild(newContent);
            headerElem.insertBefore(colHeaderElem,lastHeaderColElem);
          }

          // load body
          const bodyElem = document.getElementById("betti-euler-table-body");
          for (var i = 0; i < result.betti[0].length; i++) {
            const rowElem = document.createElement("tr");
            rowElem.setAttribute("class", "BettiAndEulerBodyRow");
            const firstColElem = document.createElement("td");
            const firstColContent = document.createTextNode(result.betti[0][i]);
            firstColElem.appendChild(firstColContent);
            rowElem.appendChild(firstColElem);
            for (let j = 0; j < result.betti.length-1; j++) {
              const curCol = document.createElement("td");
              const curColContent = document.createTextNode(result.betti[j+1][i]);
              curCol.appendChild(curColContent);
              rowElem.appendChild(curCol);
            }
            bodyElem.appendChild(rowElem);
          }
        }

        function loadStatisticsBody(result) {
          const bodyElem = document.getElementById("statistics-body");
          for (var i = 0; i < result.dim.length; i++) {
            const rowElem = document.createElement("tr");
            rowElem.setAttribute("class", "StatisticsBodyRow");
            const firstColElem = document.createElement("td");
            const firstColContent = document.createTextNode(result.dim[i]);
            firstColElem.appendChild(firstColContent);
            rowElem.appendChild(firstColElem);
            for (var j = 0; j < result.stats[i].length; j++) {
              const colElem = document.createElement("td");
              const colElemContent = document.createTextNode(result.stats[i][j]);
              colElem.appendChild(colElemContent);
              rowElem.appendChild(colElem);
            }
            bodyElem.appendChild(rowElem);
          }
        }

        function createFragment(htmlStr) {
            var frag = document.createDocumentFragment(),
                temp = document.createElement('div');
            temp.innerHTML = htmlStr;
            while (temp.firstChild) {
                frag.appendChild(temp.firstChild);
            }
            return frag;
        }

        function loadRatiosTable(result) {
          if(result.stats[1]){
            const sectionElem = document.createElement("section");
            sectionElem.setAttribute("class","Ratios");
            const tableElem = document.createElement("table");
            tableElem.setAttribute("id", "RatiosTable");
            tableElem.innerHTML = `
              <thead>
                <tr>
                  <th colspan="6">
                    <span style="float: right; font-weight: normal; text-align: right; width: 6em;">
                      [<input id="CollapseRatiosTable" type="button" onclick="collapseRatiosTable(this)" value="Hide">]
                    </span>
                    <h4>Ratios:</h4>
                  </th>
                </tr>
                <tr class="RatiosHeadRow">
                  <th>Dimensions</th>
                  <th>Ratio of number of features</th>
                  <th>Ratio of mean feature length</th>
                </tr>
              </thead>
            `;
            const tableBodyElem = document.createElement("tbody");
            var k = 0;
            const stats = result.stats;
            for (var i = 0; i < result.dim.length; i++) {
              for (var j = 0; j < result.dim.length; j++) {
                if(j>i){
                  const rowElem = document.createElement("tr");
                  rowElem.setAttribute("class", "RatiosBodyRow");
                  const col1Elem = document.createElement("td");
                  const col2Elem = document.createElement("td");
                  const col3Elem = document.createElement("td");
                  const col1Content = document.createTextNode(result.dim[i]+":"+result.dim[j]);
                  const col2Content = document.createTextNode(stats[stats.length-1][k]);
                  const col3Content = document.createTextNode(stats[stats.length-1][k+1]);
                  col1Elem.appendChild(col1Content);
                  col2Elem.appendChild(col2Content);
                  col3Elem.appendChild(col3Content);
                  rowElem.appendChild(col1Elem);
                  rowElem.appendChild(col2Elem);
                  rowElem.appendChild(col3Elem);
                  tableBodyElem.appendChild(rowElem);
                  k+=2;
                }
              }
            }
            tableElem.appendChild(tableBodyElem);
            sectionElem.appendChild(tableElem);
            document
              .getElementById("raw-data-section")
              .insertAdjacentElement("beforebegin", sectionElem);
          }
        }

        function loadRawData(result) {
          const elem = document.getElementById("raw-data-table-body");
          for (let i = 0; i < result.raw.length; i++) {
            const element = result.raw[i];
            const rowElem = document.createElement("tr");
            rowElem.setAttribute("class", "RawDataBodyRow");
            const colElem = document.createElement("td");
            const content = document.createTextNode(result.raw[i]);
            colElem.appendChild(content);
            rowElem.appendChild(colElem);
            elem.appendChild(rowElem);
          }
        }

        // Load result data to session storage if not already set
        if(window.sessionStorage.getItem("current-result") == null){
          window.sessionStorage.setItem(
              "current-result", 
              document
                .getElementById("latest-result")
                .getAttribute("data-latest-result")
            );
          }
          const result = JSON.parse(window.sessionStorage.getItem("current-result"));
          loadBettiEulerTable(result);
          loadStatisticsBody(result);
          loadRatiosTable(result);
          loadRawData(result);
      </script>
    </div>
  {% endblock %}
